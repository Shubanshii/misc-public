'use strict'

const sidebarTmp =`<div class="side-bar side-bar__visible"><div class="side-bar-tabs"><button class="side-bar-tab side-bar-tab__active"><!-- react-text: 25 -->Chat<!-- /react-text --></button><button class="side-bar-tab"><!-- react-text: 27 -->Participants (<!-- /react-text --><!-- react-text: 28 -->2<!-- /react-text --><!-- react-text: 29 -->)<!-- /react-text --></button><button class="settings-modal-button" data-tooltip="Settings" data-tooltip-pos="down"><svg width="20px" height="20px" viewBox="0 0 90 89" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="Artboard" transform="translate(-5.000000, -6.000000)" stroke="#d0d2d5" stroke-width="12"><g id="Group-2" transform="translate(11.000000, 11.000000)"><circle id="Oval" cx="39" cy="39" r="29"></circle><g id="Group" transform="translate(0.000000, 38.000000)" stroke-linecap="square"><path d="M74,1.5 L77.5,1.5" id="Line"></path><path d="M0,1.5 L3.5,1.5" id="Line-Copy" transform="translate(2.000000, 1.500000) scale(-1, 1) translate(-2.000000, -1.500000) "></path></g><g id="Group-Copy" transform="translate(39.000000, 39.500000) rotate(90.000000) translate(-39.000000, -39.500000) translate(0.000000, 38.000000)" stroke-linecap="square"><path d="M74,1.5 L77.5,1.5" id="Line"></path><path d="M0,1.5 L3.5,1.5" id="Line-Copy" transform="translate(2.000000, 1.500000) scale(-1, 1) translate(-2.000000, -1.500000) "></path></g><g id="Group-Copy-2" transform="translate(39.000000, 39.500000) rotate(130.000000) translate(-39.000000, -39.500000) translate(0.000000, 38.000000)" stroke-linecap="square"><path d="M74,1.5 L77.5,1.5" id="Line"></path><path d="M0,1.5 L3.5,1.5" id="Line-Copy" transform="translate(2.000000, 1.500000) scale(-1, 1) translate(-2.000000, -1.500000) "></path></g><g id="Group-Copy-3" transform="translate(39.000000, 39.500000) rotate(45.000000) translate(-39.000000, -39.500000) translate(0.000000, 38.000000)" stroke-linecap="square"><path d="M74,1.5 L77.5,1.5" id="Line"></path><path d="M0,1.5 L3.5,1.5" id="Line-Copy" transform="translate(2.000000, 1.500000) scale(-1, 1) translate(-2.000000, -1.500000) "></path></g></g></g></g></svg></button><button class="copy-session-link-wrapper" data-tooltip="Copy session url" data-tooltip-pos="down"><span name="link" class="tui-icon icon-link" aria-hidden="true"></span><input type="text" value="https://sessions.thinkful.com/office-hours-12651" readonly=""></button><a class="faq-link" data-tooltip="See FAQ" data-tooltip-pos="down" href="/faq" target="_blank"><span name="help" class="tui-icon icon-help" aria-hidden="true"></span></a></div><div class="chat"><div class="messages"><span class="chat-time-indicator">6:18 PM</span><div class="system-message"><strong>Ryan  Okamuro</strong><!-- react-text: 3003 --> <!-- /react-text --><!-- react-text: 3004 -->joined<!-- /react-text --><!-- react-text: 3005 -->&nbsp;<!-- /react-text --></div><span class="chat-time-indicator">7:32 PM</span><div class="system-message"><strong>Chong Patterson</strong><!-- react-text: 3009 --> <!-- /react-text --><!-- react-text: 3010 -->joined<!-- /react-text --><!-- react-text: 3011 -->&nbsp;<!-- /react-text --></div><div class="message" id="-LC15Upy01kE2YECWM1W"><img class="user-avatar message-avatar" alt="Chong Patterson" src="https://www.gravatar.com/avatar/956eb75f2de359a3e49e722379828a26?s=100&amp;d=retro"><div class="message-body"><h6 class="message-body-header">Chong Patterson</h6><span class="message-body-time">7:33 PM</span><div class="message-body-content"><p>what up ryan</p>
</div></div></div><div class="message message__compressed" id="-LC15Vqiwfz1Z6zPCt0V"><div class="message-body message-body__buffered"><div class="message-body-content"><p>!</p>
</div></div></div><span class="chat-time-indicator">7:47 PM</span><div class="system-message"><strong>Christopher Johnson</strong><!-- react-text: 3024 --> <!-- /react-text --><!-- react-text: 3025 -->joined<!-- /react-text --><!-- react-text: 3026 -->&nbsp;<!-- /react-text --></div><div class="system-message"><strong>Sungmin Yi</strong><!-- react-text: 3029 --> <!-- /react-text --><!-- react-text: 3030 -->joined<!-- /react-text --><!-- react-text: 3031 -->&nbsp;<!-- /react-text --></div><div class="system-message"><strong>Sungmin Yi</strong><!-- react-text: 3034 --> <!-- /react-text --><!-- react-text: 3035 -->joined the stage<!-- /react-text --><!-- react-text: 3036 -->&nbsp;<!-- /react-text --></div><div class="system-message"><strong>Chong Patterson</strong><!-- react-text: 3039 --> <!-- /react-text --><!-- react-text: 3040 -->left<!-- /react-text --><!-- react-text: 3041 -->&nbsp;<!-- /react-text --></div><div class="system-message"><strong>Christopher Johnson</strong><!-- react-text: 3044 --> <!-- /react-text --><!-- react-text: 3045 -->left<!-- /react-text --><!-- react-text: 3046 -->&nbsp;<!-- /react-text --></div><div class="system-message"><strong>Ryan  Okamuro</strong><!-- react-text: 3049 --> <!-- /react-text --><!-- react-text: 3050 -->left<!-- /react-text --><!-- react-text: 3051 -->&nbsp;<!-- /react-text --></div><div class="system-message"><strong>Sungmin Yi</strong><!-- react-text: 3054 --> <!-- /react-text --><!-- react-text: 3055 -->left<!-- /react-text --><!-- react-text: 3056 -->&nbsp;<!-- /react-text --></div><div class="system-message"><strong>Christopher Johnson</strong><!-- react-text: 3059 --> <!-- /react-text --><!-- react-text: 3060 -->joined<!-- /react-text --><!-- react-text: 3061 -->&nbsp;<!-- /react-text --></div><div class="system-message"><strong>Ryan  Okamuro</strong><!-- react-text: 3064 --> <!-- /react-text --><!-- react-text: 3065 -->joined<!-- /react-text --><!-- react-text: 3066 -->&nbsp;<!-- /react-text --></div><div class="system-message"><strong>Sungmin Yi</strong><!-- react-text: 3069 --> <!-- /react-text --><!-- react-text: 3070 -->joined<!-- /react-text --><!-- react-text: 3071 -->&nbsp;<!-- /react-text --></div><div class="system-message"><strong>Sungmin Yi</strong><!-- react-text: 3074 --> <!-- /react-text --><!-- react-text: 3075 -->joined the stage<!-- /react-text --><!-- react-text: 3076 -->&nbsp;<!-- /react-text --></div><div class="system-message"><strong>Phil Choi</strong><!-- react-text: 3079 --> <!-- /react-text --><!-- react-text: 3080 -->joined<!-- /react-text --><!-- react-text: 3081 -->&nbsp;<!-- /react-text --></div><div class="system-message"><strong>Phil Choi</strong><!-- react-text: 3084 --> <!-- /react-text --><!-- react-text: 3085 -->left<!-- /react-text --><!-- react-text: 3086 -->&nbsp;<!-- /react-text --></div><div class="system-message"><strong>Sungmin Yi</strong><!-- react-text: 3089 --> <!-- /react-text --><!-- react-text: 3090 -->left<!-- /react-text --><!-- react-text: 3091 -->&nbsp;<!-- /react-text --></div><span class="chat-time-indicator">7:53 PM</span><div class="system-message"><strong>Gregory Corrigan</strong><!-- react-text: 3095 --> <!-- /react-text --><!-- react-text: 3096 -->joined<!-- /react-text --><!-- react-text: 3097 -->&nbsp;<!-- /react-text --></div><span class="chat-time-indicator">7:59 PM</span><div class="system-message"><strong>Timothy Song</strong><!-- react-text: 3101 --> <!-- /react-text --><!-- react-text: 3102 -->joined<!-- /react-text --><!-- react-text: 3103 -->&nbsp;<!-- /react-text --></div><div class="system-message"><strong>Jack Melnick</strong><!-- react-text: 3106 --> <!-- /react-text --><!-- react-text: 3107 -->joined<!-- /react-text --><!-- react-text: 3108 -->&nbsp;<!-- /react-text --></div><div class="system-message"><strong>Jack Melnick</strong><!-- react-text: 3111 --> <!-- /react-text --><!-- react-text: 3112 -->joined the stage<!-- /react-text --><!-- react-text: 3113 -->&nbsp;<!-- /react-text --></div><div class="system-message"><strong>Ryan  Okamuro</strong><!-- react-text: 3116 --> <!-- /react-text --><!-- react-text: 3117 -->joined the stage<!-- /react-text --><!-- react-text: 3118 -->&nbsp;<!-- /react-text --></div><span class="chat-time-indicator">8:04 PM</span><div class="system-message"><strong>Carly Sierra</strong><!-- react-text: 3122 --> <!-- /react-text --><!-- react-text: 3123 -->joined<!-- /react-text --><!-- react-text: 3124 -->&nbsp;<!-- /react-text --></div><span class="chat-time-indicator">8:12 PM</span><div class="system-message"><strong>Chong Patterson</strong><!-- react-text: 3128 --> <!-- /react-text --><!-- react-text: 3129 -->joined<!-- /react-text --><!-- react-text: 3130 -->&nbsp;<!-- /react-text --></div><div class="system-message"><strong>William Holcombe</strong><!-- react-text: 3133 --> <!-- /react-text --><!-- react-text: 3134 -->joined<!-- /react-text --><!-- react-text: 3135 -->&nbsp;<!-- /react-text --></div><div class="system-message"><strong>Ryan  Okamuro</strong><!-- react-text: 3138 --> <!-- /react-text --><!-- react-text: 3139 -->left the stage<!-- /react-text --><!-- react-text: 3140 -->&nbsp;<!-- /react-text --></div><div class="system-message"><strong>Chong Patterson</strong><!-- react-text: 3143 --> <!-- /react-text --><!-- react-text: 3144 -->joined the stage<!-- /react-text --><!-- react-text: 3145 -->&nbsp;<!-- /react-text --></div><span class="chat-time-indicator">8:21 PM</span><div class="system-message"><strong>Chong Patterson</strong><!-- react-text: 3149 --> <!-- /react-text --><!-- react-text: 3150 -->left the stage<!-- /react-text --><!-- react-text: 3151 -->&nbsp;<!-- /react-text --></div><div class="system-message"><strong>Chong Patterson</strong><!-- react-text: 3154 --> <!-- /react-text --><!-- react-text: 3155 -->left<!-- /react-text --><!-- react-text: 3156 -->&nbsp;<!-- /react-text --></div><div class="message" id="-LC1GvB_z4WwgTc5l0l_"><img class="user-avatar message-avatar" alt="Carly Sierra" src="https://tf-assets-prod.s3.amazonaws.com/avatars/CarlySierra.png"><div class="message-body"><h6 class="message-body-header">Carly Sierra</h6><span class="message-body-time">8:23 PM</span><div class="message-body-content"><p>I can</p>
</div></div></div><div class="system-message"><strong>Timothy Song</strong><!-- react-text: 3165 --> <!-- /react-text --><!-- react-text: 3166 -->joined the stage<!-- /react-text --><!-- react-text: 3167 -->&nbsp;<!-- /react-text --></div><div class="message" id="-LC1H7sVslQL9_-WRQgv"><img class="user-avatar message-avatar" alt="Carly Sierra" src="https://tf-assets-prod.s3.amazonaws.com/avatars/CarlySierra.png"><div class="message-body"><h6 class="message-body-header">Carly Sierra</h6><span class="message-body-time">8:24 PM</span><div class="message-body-content"><p>Gonna hop off though, have a good night!</p>
</div></div></div><div class="system-message"><strong>Carly Sierra</strong><!-- react-text: 3176 --> <!-- /react-text --><!-- react-text: 3177 -->left<!-- /react-text --><!-- react-text: 3178 -->&nbsp;<!-- /react-text --></div><span class="chat-time-indicator">8:35 PM</span><div class="system-message"><strong>Ryan  Okamuro</strong><!-- react-text: 3182 --> <!-- /react-text --><!-- react-text: 3183 -->left<!-- /react-text --><!-- react-text: 3184 -->&nbsp;<!-- /react-text --></div><div class="system-message"><strong>Zhoubing Yang</strong><!-- react-text: 3187 --> <!-- /react-text --><!-- react-text: 3188 -->joined<!-- /react-text --><!-- react-text: 3189 -->&nbsp;<!-- /react-text --></div><div class="system-message"><strong>Zhoubing Yang</strong><!-- react-text: 3192 --> <!-- /react-text --><!-- react-text: 3193 -->joined<!-- /react-text --><!-- react-text: 3194 -->&nbsp;<!-- /react-text --></div><div class="system-message"><strong>Zhoubing Yang</strong><!-- react-text: 3197 --> <!-- /react-text --><!-- react-text: 3198 -->left<!-- /react-text --><!-- react-text: 3199 -->&nbsp;<!-- /react-text --></div><div class="system-message"><strong>Zhoubing Yang</strong><!-- react-text: 3202 --> <!-- /react-text --><!-- react-text: 3203 -->left<!-- /react-text --><!-- react-text: 3204 -->&nbsp;<!-- /react-text --></div><div class="system-message"><strong>Zhoubing Yang</strong><!-- react-text: 3207 --> <!-- /react-text --><!-- react-text: 3208 -->joined<!-- /react-text --><!-- react-text: 3209 -->&nbsp;<!-- /react-text --></div><div class="system-message"><strong>Elliot Kim</strong><!-- react-text: 3212 --> <!-- /react-text --><!-- react-text: 3213 -->joined<!-- /react-text --><!-- react-text: 3214 -->&nbsp;<!-- /react-text --></div><span class="chat-time-indicator">8:42 PM</span><div class="system-message"><strong>William Holcombe</strong><!-- react-text: 3218 --> <!-- /react-text --><!-- react-text: 3219 -->left<!-- /react-text --><!-- react-text: 3220 -->&nbsp;<!-- /react-text --></div><span class="chat-time-indicator">8:48 PM</span><div class="system-message"><strong>Elliot Kim</strong><!-- react-text: 3224 --> <!-- /react-text --><!-- react-text: 3225 -->left<!-- /react-text --><!-- react-text: 3226 -->&nbsp;<!-- /react-text --></div><span class="chat-time-indicator">8:54 PM</span><div class="system-message"><strong>Timothy Song</strong><!-- react-text: 3230 --> <!-- /react-text --><!-- react-text: 3231 -->left the stage<!-- /react-text --><!-- react-text: 3232 -->&nbsp;<!-- /react-text --></div><div class="system-message"><strong>Zhoubing Yang</strong><!-- react-text: 3235 --> <!-- /react-text --><!-- react-text: 3236 -->joined the stage<!-- /react-text --><!-- react-text: 3237 -->&nbsp;<!-- /react-text --></div><div class="system-message"><strong>Timothy Song</strong><!-- react-text: 3240 --> <!-- /react-text --><!-- react-text: 3241 -->left<!-- /react-text --><!-- react-text: 3242 -->&nbsp;<!-- /react-text --></div><span class="chat-time-indicator">9:02 PM</span><div class="system-message"><strong>Gregory Corrigan</strong><!-- react-text: 3246 --> <!-- /react-text --><!-- react-text: 3247 -->left<!-- /react-text --><!-- react-text: 3248 -->&nbsp;<!-- /react-text --></div><div class="system-message"><strong>Zhoubing Yang</strong><!-- react-text: 3251 --> <!-- /react-text --><!-- react-text: 3252 -->left the stage<!-- /react-text --><!-- react-text: 3253 -->&nbsp;<!-- /react-text --></div><span class="chat-time-indicator">9:07 PM</span><div class="system-message"><strong>Zhoubing Yang</strong><!-- react-text: 3260 --> <!-- /react-text --><!-- react-text: 3261 -->left<!-- /react-text --><!-- react-text: 3262 -->&nbsp;<!-- /react-text --></div></div><form class="chat-form"><textarea class="chat-form-input" placeholder="Chat" style="height: 45px;"></textarea><input type="submit" class="chat-form-submit"></form></div></div>`

const thinkfulWaitingListConfig = {
  seedChat:false,
  studentPopUpObj:{}
};

const gatherStudents = () =>
{
  let fullStudentObj = {...thinkfulWaitingListConfig.studentPopUpObj}
  const fullStudentNodeList = document.querySelectorAll('.system-message'),
        fullStudentList = [...fullStudentNodeList];

  fullStudentList.forEach((itm) => {
    fullStudentObj[itm.firstChild.innerText] = fullStudentObj[itm.firstChild.innerText] || {};
    fullStudentObj[itm.firstChild.innerText].online = (~itm.innerText.indexOf('join')) ? true : false
    fullStudentObj[itm.firstChild.innerText].completed = (fullStudentObj[itm.firstChild.innerText].completed) ? true : false
  });

  // console.log('fullStudentList:',fullStudentList);
  // console.log('fullStudentObj:',fullStudentObj);
  thinkfulWaitingListConfig.studentPopUpObj = fullStudentObj;

  sendStudentsToPopUp();
}
const sendStudentsToPopUp = () =>
{
  chrome.runtime.sendMessage(thinkfulWaitingListConfig.studentPopUpObj, function(response) {
  // console.log(response);
});
}

chrome.runtime.onMessage.addListener(
  function(request, sender, sendResponse)
  {
    // console.log('request:',request);
    thinkfulWaitingListConfig.studentPopUpObj = request
    // chrome.storage.sync.set({students:request})
    sendResponse({handoff: "successful"});
    // setStudentStatusView(request);
  }
);

const watchForSidebar = () =>
{
  if(!document.querySelector('.side-bar__visible'))
  { setTimeout(watchForSidebar,500); }
  else
  {
    if(thinkfulWaitingListConfig.seedChat)
    { document.querySelector('.side-bar__visible').innerHTML = sidebarTmp }
  }

  gatherStudents();
}

(function(){
  watchForSidebar();
})()
